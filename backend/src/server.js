const mongoose = require('mongoose');
const app = require('./app');
require('dotenv').config();

// ==========================================
// DATABASE CONNECTION
// ==========================================

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    
    console.log('‚úÖ MongoDB connected successfully');
    console.log(`üì¶ Database: ${mongoose.connection.name}`);
    
  } catch (error) {
    console.error('‚ùå MongoDB connection error:', error.message);
    process.exit(1);
  }
};

// Handle connection events
mongoose.connection.on('disconnected', () => {
  console.log('‚ö†Ô∏è  MongoDB disconnected');
});

mongoose.connection.on('error', (err) => {
  console.error('‚ùå MongoDB error:', err);
});

// ==========================================
// START SERVER
// ==========================================

const PORT = process.env.PORT || 3001;
const NODE_ENV = process.env.NODE_ENV || 'development';

const startServer = async () => {
  // Connect to database first
  await connectDB();
  
  // Start Express server
  app.listen(PORT, () => {
    console.log('');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üöÄ Server Started Successfully');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log(`üìç Environment: ${NODE_ENV}`);
    console.log(`üåê Server: http://localhost:${PORT}`);
    console.log(`üì° API Base: http://localhost:${PORT}/api`);
    console.log(`üè• Health Check: http://localhost:${PORT}/api/health`);
    console.log('');
    console.log('Available Endpoints:');
    console.log(`   Customer Login:  POST http://localhost:${PORT}/api/v1/auth/customer/login`);
    console.log(`   Admin Login:   POST http://localhost:${PORT}/api/v1/auth/admin/login`);
    console.log(`   Analysis:      POST http://localhost:${PORT}/api/v1/customer/analysis`);
    console.log(`   Analytics:     GET  http://localhost:${PORT}/api/v1/admin/analytics/overview`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('');
  });
};

// ==========================================
// GRACEFUL SHUTDOWN
// ==========================================

const gracefulShutdown = async () => {
  console.log('\nüîÑ Shutting down gracefully...');
  
  try {
    // Close database connection
    await mongoose.connection.close();
    console.log('‚úÖ MongoDB connection closed');
    
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error during shutdown:', error);
    process.exit(1);
  }
};

// Handle shutdown signals
process.on('SIGTERM', gracefulShutdown);
process.on('SIGINT', gracefulShutdown);

// Handle unhandled promise rejections
process.on('unhandledRejection', (err) => {
  console.error('‚ùå Unhandled Promise Rejection:', err);
  gracefulShutdown();
});

// ==========================================
// INITIALIZE
// ==========================================

startServer();